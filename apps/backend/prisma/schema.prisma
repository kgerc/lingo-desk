// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  TEACHER
  STUDENT
  PARENT
}

enum LessonStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  PENDING_CONFIRMATION
  NO_SHOW
}

enum LessonDeliveryMode {
  IN_PERSON
  ONLINE
}

enum CourseFormat {
  GROUP
  INDIVIDUAL
}

enum CourseDeliveryMode {
  IN_PERSON
  ONLINE
  BOTH
}

enum LanguageLevel {
  A1
  A2
  B1
  B2
  C1
  C2
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  STRIPE
  CASH
  BANK_TRANSFER
}

enum PaymentMode {
  PACKAGE     // Hours-based: buy X hours, use them for lessons
  PER_LESSON  // Per lesson: create payment for each completed lesson
  BALANCE     // Balance-based: payments increase balance, lessons decrease balance
}

enum ContractType {
  B2B
  EMPLOYMENT
  CIVIL
}

enum NotificationType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum MessageStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

enum MessageRecipientType {
  ALL_STUDENTS
  COURSE_STUDENTS
  INDIVIDUAL_STUDENTS
  ALL_TEACHERS
  INDIVIDUAL_TEACHERS
}

// ============================================
// CORE MODELS
// ============================================

model Organization {
  id                   String   @id @default(uuid())
  name                 String
  slug                 String   @unique
  logoUrl              String?  @map("logo_url")
  primaryColor         String?  @default("#3B82F6") @map("primary_color")
  timezone             String   @default("Europe/Warsaw")
  currency             String   @default("PLN")
  country              String   @default("PL")
  address              String?
  city                 String?
  postalCode           String?  @map("postal_code")
  phone                String?
  email                String?
  website              String?
  taxId                String?  @map("tax_id") // NIP for Poland
  description          String?
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  users                 User[] @relation("PrimaryOrganization")
  userOrganizations     UserOrganization[]
  students              Student[]
  teachers              Teacher[]
  courses               Course[]
  packages              Package[]
  subscriptions         Subscription[]
  lessons               Lesson[]
  recurringPatterns     RecurringPattern[]
  locations             Location[]
  payments              Payment[]
  notifications         Notification[]
  notificationTemplates NotificationTemplate[]
  files                 File[]
  notes                 Note[]
  alerts                Alert[]
  settings              OrganizationSettings?
  googleCalendarSyncs   GoogleCalendarSync[]
  exchangeRates         ExchangeRate[]
  studentSettlements    StudentSettlement[]
  substitutions         Substitution[]
  teacherPayouts        TeacherPayout[]

  @@map("organizations")
}

model User {
  id               String    @id @default(uuid())
  organizationId   String    @map("organization_id")
  email            String    @unique
  passwordHash     String    @map("password_hash")
  firstName        String    @map("first_name")
  lastName         String    @map("last_name")
  phone            String?
  avatarUrl        String?   @map("avatar_url")
  role             UserRole
  isActive         Boolean   @default(true) @map("is_active")
  lastLoginAt      DateTime? @map("last_login_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  organization        Organization        @relation("PrimaryOrganization", fields: [organizationId], references: [id], onDelete: Cascade)
  organizations       UserOrganization[]
  profile             UserProfile?
  teacher             Teacher?
  student             Student?
  parentRelations     ParentStudentRelation[] @relation("ParentRelations")
  notifications       Notification[]
  filesUploaded       File[]
  notesCreated        Note[]
  alerts              Alert[]
  googleCalendarSync  GoogleCalendarSync?

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model UserProfile {
  id                      String   @id @default(uuid())
  userId                  String   @unique @map("user_id")
  dateOfBirth             DateTime? @map("date_of_birth")
  address                 String?
  emergencyContact        String?  @map("emergency_contact")
  notes                   String?
  languagePreference      String   @default("pl") @map("language_preference")
  notificationPreferences Json?    @map("notification_preferences")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// ============================================
// TEACHERS
// ============================================

model Teacher {
  id                     String       @id @default(uuid())
  userId                 String       @unique @map("user_id")
  organizationId         String       @map("organization_id")
  hourlyRate             Decimal      @map("hourly_rate") @db.Decimal(10, 2)
  contractType           ContractType? @map("contract_type")
  specializations        String[]
  languages              String[]
  bio                    String?
  isAvailableForBooking  Boolean      @default(true) @map("is_available_for_booking")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")

  // Relations
  user                     User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization             Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  courses                  Course[]
  lessons                  Lesson[]
  payouts                  TeacherPayout[]
  substitutionsAsOriginal  Substitution[]             @relation("OriginalTeacher")
  substitutionsAsSubstitute Substitution[]            @relation("SubstituteTeacher")

  @@index([organizationId])
  @@map("teachers")
}

// ============================================
// STUDENTS
// ============================================

model Student {
  id             String        @id @default(uuid())
  userId         String        @unique @map("user_id")
  organizationId String        @map("organization_id")
  studentNumber  String        @map("student_number")
  enrollmentDate DateTime      @default(now()) @map("enrollment_date")
  languageLevel  LanguageLevel @map("language_level")
  language            String        @default("en") // Language being learned (ISO 639-1 code: en, de, es, fr, it, pl)
  goals               String?
  isMinor             Boolean       @default(false) @map("is_minor")
  paymentDueDays      Int?          @map("payment_due_days")
  paymentDueDayOfMonth Int?         @map("payment_due_day_of_month")
  // Paid cancellation settings
  cancellationFeeEnabled    Boolean  @default(false) @map("cancellation_fee_enabled")
  cancellationHoursThreshold Int?    @map("cancellation_hours_threshold") // Hours before lesson when fee applies
  cancellationFeePercent    Int?     @map("cancellation_fee_percent") // Percentage of lesson price (0-100)
  // Cancellation limit settings
  cancellationLimitEnabled  Boolean  @default(false) @map("cancellation_limit_enabled")
  cancellationLimitCount    Int?     @map("cancellation_limit_count") // Max cancellations allowed per period
  cancellationLimitPeriod   String?  @map("cancellation_limit_period") // Period: 'month', 'quarter', 'year', 'enrollment'
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  user              User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentRelations   ParentStudentRelation[]  @relation("StudentRelations")
  enrollments       StudentEnrollment[]
  lessons           Lesson[]
  payments          Payment[]
  budget            StudentBudget?
  attendances       LessonAttendance[]
  settlements       StudentSettlement[]

  @@unique([organizationId, studentNumber])
  @@index([organizationId])
  @@map("students")
}

model ParentStudentRelation {
  id                String   @id @default(uuid())
  parentId          String   @map("parent_id")
  studentId         String   @map("student_id")
  relationshipType  String   @default("parent") @map("relationship_type")
  canManagePayments Boolean  @default(true) @map("can_manage_payments")
  canManageSchedule Boolean  @default(true) @map("can_manage_schedule")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  parent  User    @relation("ParentRelations", fields: [parentId], references: [id], onDelete: Cascade)
  student Student @relation("StudentRelations", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@map("parent_student_relations")
}

// ============================================
// COURSES & PACKAGES
// ============================================


model Course {
  id                     String             @id @default(uuid())
  organizationId         String             @map("organization_id")
  teacherId              String             @map("teacher_id")
  name                   String
  // Pola przeniesione z CourseType:
  courseType             CourseFormat       @default(INDIVIDUAL) @map("course_type")
  language               String             @default("en")
  level                  LanguageLevel      @default(A1)
  deliveryMode           CourseDeliveryMode @default(ONLINE) @map("delivery_mode")
  defaultDurationMinutes Int                @default(60) @map("default_duration_minutes")
  pricePerLesson         Decimal            @default(0) @map("price_per_lesson") @db.Decimal(10, 2)
  currency               String             @default("PLN")
  description            String?
  // IstniejÄ…ce pola:
  startDate              DateTime           @map("start_date")
  endDate                DateTime?          @map("end_date")
  isActive               Boolean            @default(true) @map("is_active")
  locationId             String?            @map("location_id")
  classroomId            String?            @map("classroom_id")
  maxStudents            Int?               @map("max_students")
  currentStudentsCount   Int                @default(0) @map("current_students_count")
  createdAt              DateTime           @default(now()) @map("created_at")
  updatedAt              DateTime           @updatedAt @map("updated_at")

  // Relations
  organization  Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacher       Teacher             @relation(fields: [teacherId], references: [id])
  location      Location?           @relation(fields: [locationId], references: [id])
  classroom     Classroom?          @relation(fields: [classroomId], references: [id])
  enrollments   StudentEnrollment[]
  lessons       Lesson[]
  materials     CourseMaterial[]

  @@index([organizationId])
  @@index([teacherId])
  @@index([isActive])
  @@map("courses")
}

model Package {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  name           String
  description    String?
  totalHours     Decimal     @map("total_hours") @db.Decimal(10, 2)
  price          Decimal     @db.Decimal(10, 2)
  validityDays   Int         @map("validity_days")
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  enrollments  StudentEnrollment[]

  @@index([organizationId])
  @@map("packages")
}

model Subscription {
  id               String      @id @default(uuid())
  organizationId   String      @map("organization_id")
  name             String
  description      String?
  monthlyPrice     Decimal     @map("monthly_price") @db.Decimal(10, 2)
  lessonsPerMonth  Int         @map("lessons_per_month")
  isActive         Boolean     @default(true) @map("is_active")
  stripeProductId  String?     @map("stripe_product_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  enrollments  StudentEnrollment[]

  @@index([organizationId])
  @@map("subscriptions")
}

model StudentEnrollment {
  id               String           @id @default(uuid())
  studentId        String           @map("student_id")
  courseId         String?          @map("course_id")
  packageId        String?          @map("package_id")
  subscriptionId   String?          @map("subscription_id")
  enrollmentDate   DateTime         @default(now()) @map("enrollment_date")
  status           EnrollmentStatus
  paymentMode      PaymentMode      @default(PACKAGE) @map("payment_mode")
  hoursPurchased   Decimal          @map("hours_purchased") @db.Decimal(10, 2)
  hoursUsed        Decimal          @default(0) @map("hours_used") @db.Decimal(10, 2)
  expiresAt        DateTime?        @map("expires_at")
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course       Course?       @relation(fields: [courseId], references: [id])
  package      Package?      @relation(fields: [packageId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])
  lessons      Lesson[]
  payments     Payment[]

  @@index([studentId])
  @@index([courseId])
  @@index([status])
  @@map("student_enrollments")
}

// ============================================
// SCHEDULING
// ============================================

model Lesson {
  id                    String             @id @default(uuid())
  organizationId        String             @map("organization_id")
  courseId              String?            @map("course_id")
  enrollmentId          String?            @map("enrollment_id")
  teacherId             String             @map("teacher_id")
  studentId             String             @map("student_id")
  title                 String
  description           String?
  scheduledAt           DateTime           @map("scheduled_at")
  durationMinutes       Int                @default(60) @map("duration_minutes")
  teacherRate           Decimal?           @map("teacher_rate") @db.Decimal(10, 2)
  pricePerLesson        Decimal?           @map("price_per_lesson") @db.Decimal(10, 2) // Price charged to student
  currency              String             @default("PLN")
  locationId            String?            @map("location_id")
  classroomId           String?            @map("classroom_id")
  deliveryMode          LessonDeliveryMode @map("delivery_mode")
  meetingUrl            String?            @map("meeting_url")
  status                LessonStatus
  isRecurring           Boolean            @default(false) @map("is_recurring")
  recurringPatternId    String?            @map("recurring_pattern_id")
  cancelledAt           DateTime?          @map("cancelled_at")
  cancellationReason    String?            @map("cancellation_reason")
  cancellationFeeApplied Boolean           @default(false) @map("cancellation_fee_applied")
  cancellationFeeAmount  Decimal?          @map("cancellation_fee_amount") @db.Decimal(10, 2)
  cancellationFeePaymentId String?         @map("cancellation_fee_payment_id")
  completedAt           DateTime?          @map("completed_at")
  confirmedByTeacherAt  DateTime?          @map("confirmed_by_teacher_at")
  createdAt             DateTime           @default(now()) @map("created_at")
  updatedAt             DateTime           @updatedAt @map("updated_at")

  // Relations
  organization        Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  course              Course?                    @relation(fields: [courseId], references: [id])
  enrollment          StudentEnrollment?         @relation(fields: [enrollmentId], references: [id])
  teacher             Teacher                    @relation(fields: [teacherId], references: [id])
  student             Student                    @relation(fields: [studentId], references: [id])
  location            Location?                  @relation(fields: [locationId], references: [id])
  classroom           Classroom?                 @relation(fields: [classroomId], references: [id])
  recurringPattern    RecurringPattern?          @relation(fields: [recurringPatternId], references: [id])
  attendances         LessonAttendance[]
  payments            Payment[]
  googleCalendarEvent LessonGoogleCalendarEvent?
  substitution        Substitution?
  payoutLessons       TeacherPayoutLesson[]

  @@index([organizationId])
  @@index([teacherId])
  @@index([studentId])
  @@index([scheduledAt])
  @@index([status])
  @@index([teacherId, scheduledAt])
  @@index([studentId, scheduledAt])
  // Performance indexes for common queries
  @@index([organizationId, scheduledAt, status]) // Dashboard & calendar queries
  @@index([organizationId, status, scheduledAt]) // Filtered list queries
  @@index([organizationId, teacherId, status])   // Teacher-specific queries
  @@index([organizationId, studentId, status])   // Student-specific queries
  @@map("lessons")
}

model RecurringPattern {
  id                   String             @id @default(uuid())
  organizationId       String             @map("organization_id")
  frequency            RecurringFrequency
  interval             Int                @default(1)
  dayOfWeek            Int?               @map("day_of_week") // 0-6
  daysOfWeek           Int[]              @map("days_of_week")
  startDate            DateTime           @map("start_date")
  endDate              DateTime?          @map("end_date")
  occurrencesCount     Int?               @map("occurrences_count")
  createdLessonsCount  Int                @default(0) @map("created_lessons_count")
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lessons      Lesson[]

  @@map("recurring_patterns")
}

model LessonAttendance {
  id        String           @id @default(uuid())
  lessonId  String           @map("lesson_id")
  studentId String           @map("student_id")
  status    AttendanceStatus
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  // Relations
  lesson  Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id])

  @@unique([lessonId, studentId])
  @@map("lesson_attendances")
}

model Substitution {
  id                    String   @id @default(uuid())
  organizationId        String   @map("organization_id")
  lessonId              String   @unique @map("lesson_id")
  originalTeacherId     String   @map("original_teacher_id")
  substituteTeacherId   String   @map("substitute_teacher_id")
  reason                String?
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lesson            Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  originalTeacher   Teacher      @relation("OriginalTeacher", fields: [originalTeacherId], references: [id])
  substituteTeacher Teacher      @relation("SubstituteTeacher", fields: [substituteTeacherId], references: [id])

  @@index([organizationId])
  @@index([lessonId])
  @@index([originalTeacherId])
  @@index([substituteTeacherId])
  @@map("substitutions")
}

// ============================================
// PAYMENTS & FINANCE
// ============================================

model Payment {
  id                    String        @id @default(uuid())
  organizationId        String        @map("organization_id")
  studentId             String        @map("student_id")
  enrollmentId          String?       @map("enrollment_id")
  lessonId              String?       @map("lesson_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("PLN")
  exchangeRateOverride  Decimal?      @map("exchange_rate_override") @db.Decimal(10, 6) // Manual override of exchange rate
  status                PaymentStatus
  paymentMethod         PaymentMethod @map("payment_method")
  stripePaymentIntentId String?       @unique @map("stripe_payment_intent_id")
  paidAt                DateTime?     @map("paid_at")
  dueAt                 DateTime?     @map("due_at")
  notes                 String?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student      Student            @relation(fields: [studentId], references: [id])
  enrollment   StudentEnrollment? @relation(fields: [enrollmentId], references: [id])
  lesson       Lesson?            @relation(fields: [lessonId], references: [id])
  invoice      Invoice?

  @@index([organizationId])
  @@index([studentId])
  @@index([lessonId])
  @@index([status])
  @@index([paidAt])
  @@index([dueAt])
  // Performance indexes for common queries
  @@index([organizationId, status, dueAt])     // Debtors/overdue queries
  @@index([organizationId, studentId, status]) // Student payment history
  @@index([studentId, status, dueAt])          // Student debtors check
  @@map("payments")
}

model Invoice {
  id            String   @id @default(uuid())
  organizationId String   @map("organization_id")
  paymentId     String   @unique @map("payment_id")
  invoiceNumber String   @map("invoice_number")
  issueDate     DateTime @map("issue_date")
  dueDate       DateTime @map("due_date")
  studentId     String   @map("student_id")
  totalAmount   Decimal  @map("total_amount") @db.Decimal(10, 2)
  taxAmount     Decimal  @default(0) @map("tax_amount") @db.Decimal(10, 2)
  fileUrl       String?  @map("file_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([organizationId, invoiceNumber])
  @@map("invoices")
}

model StudentBudget {
  id                  String   @id @default(uuid())
  studentId           String   @unique @map("student_id")
  organizationId      String   @map("organization_id")
  totalHoursPurchased Decimal  @default(0) @map("total_hours_purchased") @db.Decimal(10, 2)
  totalHoursUsed      Decimal  @default(0) @map("total_hours_used") @db.Decimal(10, 2)
  balance             Decimal  @default(0) @db.Decimal(10, 2) // Deprecated, use currentBalance
  currentBalance      Decimal  @default(0) @map("current_balance") @db.Decimal(10, 2) // Financial balance (negative = debt, positive = credit)
  currency            String   @default("PLN")
  lastSettlementDate  DateTime? @map("last_settlement_date")
  lastUpdatedAt       DateTime @updatedAt @map("last_updated_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  student      Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  settlements  StudentSettlement[]
  transactions BalanceTransaction[]

  @@index([studentId])
  @@map("student_budgets")
}

model BalanceTransaction {
  id              String                 @id @default(uuid())
  budgetId        String                 @map("budget_id")
  type            BalanceTransactionType
  amount          Decimal                @db.Decimal(10, 2) // Always positive, type determines direction
  balanceBefore   Decimal                @map("balance_before") @db.Decimal(10, 2)
  balanceAfter    Decimal                @map("balance_after") @db.Decimal(10, 2)
  currency        String                 @default("PLN")
  description     String
  // References to related entities
  paymentId       String?                @map("payment_id")
  lessonId        String?                @map("lesson_id")
  createdBy       String?                @map("created_by") // User who initiated (for adjustments)
  metadata        Json?                  // Additional context
  createdAt       DateTime               @default(now()) @map("created_at")

  // Relations
  budget StudentBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([budgetId])
  @@index([type])
  @@index([createdAt])
  @@index([lessonId])
  @@index([paymentId])
  @@map("balance_transactions")
}

model StudentSettlement {
  id                    String   @id @default(uuid())
  organizationId        String   @map("organization_id")
  studentId             String   @map("student_id")
  budgetId              String   @map("budget_id")
  periodStart           DateTime @map("period_start")
  periodEnd             DateTime @map("period_end")
  totalPaymentsDue      Decimal  @map("total_payments_due") @db.Decimal(10, 2)    // Sum of all payments (charges) in period
  totalPaymentsReceived Decimal  @map("total_payments_received") @db.Decimal(10, 2) // Sum of all completed payments (deposits) in period
  balanceBefore         Decimal  @map("balance_before") @db.Decimal(10, 2)        // Balance at period start
  balanceAfter          Decimal  @map("balance_after") @db.Decimal(10, 2)         // Balance at period end
  currency              String   @default("PLN")
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  budget       StudentBudget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([studentId])
  @@index([periodStart, periodEnd])
  @@map("student_settlements")
}

model TeacherPayout {
  id                     String               @id @default(uuid())
  organizationId         String               @map("organization_id")
  teacherId              String               @map("teacher_id")
  periodStart            DateTime             @map("period_start")
  periodEnd              DateTime             @map("period_end")
  totalHours             Decimal              @map("total_hours") @db.Decimal(10, 2)
  totalAmount            Decimal              @map("total_amount") @db.Decimal(10, 2)
  currency               String               @default("PLN")
  status                 TeacherPayoutStatus  @default(PENDING)
  paidAt                 DateTime?            @map("paid_at")
  notes                  String?
  createdAt              DateTime             @default(now()) @map("created_at")
  updatedAt              DateTime             @updatedAt @map("updated_at")

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teacher      Teacher              @relation(fields: [teacherId], references: [id])
  lessons      TeacherPayoutLesson[]

  @@index([organizationId])
  @@index([teacherId])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@map("teacher_payouts")
}

enum TeacherPayoutStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

model TeacherPayoutLesson {
  id                  String        @id @default(uuid())
  payoutId            String        @map("payout_id")
  lessonId            String        @map("lesson_id")
  lessonDate          DateTime      @map("lesson_date")
  durationMinutes     Int           @map("duration_minutes")
  hourlyRate          Decimal       @map("hourly_rate") @db.Decimal(10, 2)
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("PLN")
  qualificationReason String        @map("qualification_reason") // COMPLETED, CONFIRMED, LATE_CANCELLATION
  studentName         String        @map("student_name")
  lessonTitle         String        @map("lesson_title")
  createdAt           DateTime      @default(now()) @map("created_at")

  // Relations
  payout  TeacherPayout @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  lesson  Lesson        @relation(fields: [lessonId], references: [id])

  @@unique([payoutId, lessonId])
  @@index([payoutId])
  @@index([lessonId])
  @@map("teacher_payout_lessons")
}

// ============================================
// COMMUNICATION
// ============================================

model Notification {
  id             String             @id @default(uuid())
  organizationId String             @map("organization_id")
  userId         String             @map("user_id")
  type           NotificationType
  channel        String
  subject        String?
  body           String
  status         NotificationStatus
  sentAt         DateTime?          @map("sent_at")
  readAt         DateTime?          @map("read_at")
  metadata       Json?
  createdAt      DateTime           @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationTemplate {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  triggerEvent   String   @map("trigger_event")
  subjectTemplate String  @map("subject_template")
  bodyTemplate   String   @map("body_template")
  channels       String[]
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("notification_templates")
}

model Note {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  createdBy     String   @map("created_by")
  relatedToType String   @map("related_to_type")
  relatedToId   String   @map("related_to_id")
  content       String
  isPrivate     Boolean  @default(false) @map("is_private")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation(fields: [createdBy], references: [id])

  @@index([relatedToType, relatedToId])
  @@index([createdBy])
  @@map("notes")
}

// ============================================
// FILES & MATERIALS
// ============================================

model File {
  id            String   @id @default(uuid())
  organizationId String  @map("organization_id")
  uploadedBy    String   @map("uploaded_by")
  fileName      String   @map("file_name")
  fileType      String   @map("file_type")
  fileSize      BigInt   @map("file_size")
  storagePath   String   @map("storage_path")
  publicUrl     String   @map("public_url")
  relatedToType String?  @map("related_to_type")
  relatedToId   String?  @map("related_to_id")
  isPublic      Boolean  @default(false) @map("is_public")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploader       User             @relation(fields: [uploadedBy], references: [id])
  courseMaterials CourseMaterial[]

  @@index([organizationId])
  @@index([relatedToType, relatedToId])
  @@map("files")
}

model CourseMaterial {
  id          String   @id @default(uuid())
  courseId    String   @map("course_id")
  fileId      String   @map("file_id")
  title       String
  description String?
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  file   File   @relation(fields: [fileId], references: [id])

  @@index([courseId])
  @@map("course_materials")
}

// ============================================
// SETTINGS & CONFIG
// ============================================

model Location {
  id             String      @id @default(uuid())
  organizationId String      @map("organization_id")
  name           String
  address        String?
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  classrooms   Classroom[]
  courses      Course[]
  lessons      Lesson[]

  @@map("locations")
}

model Classroom {
  id         String   @id @default(uuid())
  locationId String   @map("location_id")
  name       String
  capacity   Int?
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  courses  Course[]
  lessons  Lesson[]

  @@index([locationId])
  @@map("classrooms")
}

model OrganizationSettings {
  id                         String   @id @default(uuid())
  organizationId             String   @unique @map("organization_id")
  lessonReminderHours        Int      @default(1) @map("lesson_reminder_hours") // Hours before lesson to send reminder
  budgetAlertThresholdHours  Int      @default(2) @map("budget_alert_threshold_hours")
  autoGenerateLessonsEnabled Boolean  @default(true) @map("auto_generate_lessons_enabled")
  stripeAccountId            String?  @map("stripe_account_id")
  stripePublishableKey       String?  @map("stripe_publishable_key")
  emailFromAddress           String?  @map("email_from_address")
  emailFromName              String?  @map("email_from_name")
  smsEnabled                 Boolean  @default(false) @map("sms_enabled")
  timezone                   String   @default("Europe/Warsaw")
  settings                   Json?
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("organization_settings")
}

// ============================================
// USER ORGANIZATIONS (Many-to-Many)
// ============================================

model UserOrganization {
  id               String       @id @default(uuid())
  userId           String       @map("user_id")
  organizationId   String       @map("organization_id")
  role             UserRole
  isActive         Boolean      @default(true) @map("is_active")
  isPrimary        Boolean      @default(false) @map("is_primary") // Primary organization for user
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
  @@map("user_organizations")
}

// ============================================
// ALERTS & NOTIFICATIONS
// ============================================

model Alert {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  userId         String?   @map("user_id") // Null means alert for all users in org
  type           AlertType
  title          String
  message        String
  isRead         Boolean   @default(false) @map("is_read")
  readAt         DateTime? @map("read_at")
  metadata       Json?     // Additional data (e.g., lessonId, studentId)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([isRead])
  @@map("alerts")
}

enum AlertType {
  ERROR
  WARNING
  INFO
  SUCCESS
}

enum BalanceTransactionType {
  DEPOSIT           // Payment received - increases balance
  LESSON_CHARGE     // Lesson completed - decreases balance
  LESSON_REFUND     // Lesson uncompleted/reverted - increases balance
  CANCELLATION_FEE  // Late cancellation fee - decreases balance
  ADJUSTMENT        // Manual adjustment by admin
  REFUND            // Refund to student - decreases balance
}

// ============================================
// GOOGLE CALENDAR INTEGRATION
// ============================================

model GoogleCalendarSync {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  organizationId        String    @map("organization_id")
  accessToken           String    @map("access_token")
  refreshToken          String    @map("refresh_token")
  tokenExpiry           DateTime  @map("token_expiry")
  calendarId            String    @map("calendar_id") // Primary calendar ID
  watchChannelId        String?   @map("watch_channel_id") // For push notifications
  watchResourceId       String?   @map("watch_resource_id")
  watchExpiration       DateTime? @map("watch_expiration")
  syncToken             String?   @map("sync_token") // For incremental sync
  isActive              Boolean   @default(true) @map("is_active")
  lastSyncAt            DateTime? @map("last_sync_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lessons        LessonGoogleCalendarEvent[]
  externalEvents ExternalCalendarEvent[]

  @@unique([userId])
  @@index([organizationId])
  @@index([userId])
  @@map("google_calendar_syncs")
}

model LessonGoogleCalendarEvent {
  id                      String   @id @default(uuid())
  lessonId                String   @map("lesson_id")
  googleCalendarSyncId    String   @map("google_calendar_sync_id")
  googleEventId           String   @map("google_event_id")
  googleEventEtag         String?  @map("google_event_etag") // For conflict detection
  lastSyncedAt            DateTime @map("last_synced_at")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  lesson              Lesson               @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  googleCalendarSync  GoogleCalendarSync   @relation(fields: [googleCalendarSyncId], references: [id], onDelete: Cascade)

  @@unique([lessonId])
  @@unique([googleEventId, googleCalendarSyncId])
  @@index([googleCalendarSyncId])
  @@map("lesson_google_calendar_events")
}

model ExternalCalendarEvent {
  id                   String   @id @default(uuid())
  googleCalendarSyncId String   @map("google_calendar_sync_id")
  googleEventId        String   @map("google_event_id")
  title                String
  description          String?
  startTime            DateTime @map("start_time")
  endTime              DateTime @map("end_time")
  location             String?
  isAllDay             Boolean  @default(false) @map("is_all_day")
  googleEventEtag      String?  @map("google_event_etag")
  lastSyncedAt         DateTime @map("last_synced_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  googleCalendarSync GoogleCalendarSync @relation(fields: [googleCalendarSyncId], references: [id], onDelete: Cascade)

  @@unique([googleEventId, googleCalendarSyncId])
  @@index([googleCalendarSyncId])
  @@index([startTime])
  @@map("external_calendar_events")
}

// ============================================
// EXCHANGE RATES
// ============================================

model ExchangeRate {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  currency       String   // e.g., 'USD', 'EUR', 'GBP'
  rate           Decimal  @db.Decimal(10, 6) // Rate to PLN (1 currency = X PLN)
  effectiveDate  DateTime @map("effective_date") // Date when this rate is effective
  source         String   @default("NBP") // 'NBP' or 'MANUAL'
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, currency, effectiveDate])
  @@index([organizationId])
  @@index([currency])
  @@index([effectiveDate])
  @@map("exchange_rates")
}
